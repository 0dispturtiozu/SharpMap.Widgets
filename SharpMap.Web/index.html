<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">

<html>
<head>
    <title>Leaflet SharpMap Example</title>
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE" />
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v1.0.0-rc.1/leaflet.css" />
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html,
        body,
        #map {
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="map" />
    <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet/v1.0.0-rc.1/leaflet.js"></script>
    <script src="./NonTiledLayer.js"></script>
    <script src="./NonTiledLayer.WMS.js"></script>
    <script src="./token.js"></script>
    <script>
        // initialize leaflet
        var map = new L.Map('map',
        {
            worldCopyJump: true,
            zoomSnap: 0.125
        });

        // center Europe
        map.setView(new L.LatLng(50, 10), 6);

        // using the xmap WMS servlet
        var xMapUrl = 'https://api-eu-test.cloud.ptvgroup.com';
        var xMapAttribution = '<a href="http://www.ptvgroup.com">PTV<\/a>, TOMTOM';

        // add the xServer layers
        // set the layer groups for default and sandbox
        var baseLayers = {
            "PTV classic": getXMap1Layers(xMapUrl + '/WMS/WMS', "", xMapAttribution),
            "PTV sandbox": getXMap1Layers(xMapUrl + '/WMS/WMS', "sandbox", xMapAttribution),
            "PTV silkysand": getXMap1Layers(xMapUrl + '/WMS/WMS', "silkysand", xMapAttribution),
            "PTV silkysand": getXMap1Layers(xMapUrl + '/WMS/WMS', "gravelpit", xMapAttribution).addTo(map)
        };

        // add dymamic tile layer
        var myTileLayerUrl = 'SharpMapTilesHandler.ashx?x={x}&y={y}&z={z}',
	    myTileLayer = new L.TileLayer(myTileLayerUrl, {
	        maxZoom: 20, minZoom: 0, zIndex: 100
	    }).addTo(map);

        // add dymamic overlay layer
        var myOverlayLayer = new L.NonTiledLayer.WMS('SharpMapOverlayHandler.ashx', {
            zIndex: 1,
            opacity: 1.0,
            layers: '',
            format: 'image/png',
            transparent: true
        }).addTo(map);

        // add controls
        L.control.layers(baseLayers, {"Areas": myTileLayer, "POIs": myOverlayLayer}, { autoZIndex: false }).addTo(map);
        L.control.scale().addTo(map);

        // set cursor always interactive
        $('.leaflet-container').css('cursor', 'pointer');

        // needed to identify the latest reuqest
        var tick = 0;

        // add click handler
        map.on('click', function onMapClick(e) {
            $.ajax({
                url: "SharpMapPickHandler.ashx?lat=" + e.latlng.lat + "&lng=" + e.latlng.lng + "&z=" + map.getZoom(),
                type: "GET",
                success: function (data, status, xhr) {
                    displayResult(data, e.latlng, ++tick);
                }
            });
        });

        var pickedFeature;

        map.on('popupclose', function (e) {
            // remove old selection (deferred)
            if (pickedFeature) {
                setTimeout(function () {
                    map.removeLayer(pickedFeature);
                    pickedFeature = null;
                }, 0);
            }
        });

        function displayResult(pickedJson, latlng, t) {

            // obsolete result
            if (t != tick)
                return;

            // remove old selection
            if (pickedFeature) {
                map.removeLayer(pickedFeature);
                pickedFeature = null;
            }

            // return if result was empty
            if (!pickedJson || !pickedJson.geometry)
                return;

            // create a new layer from the json
            pickedFeature = L.geoJson([pickedJson], {
                style: function (feature) {  
                    return {
                        weight: 4, color: "#222", opacity: 1,
                        fillColor: "#fff", fillOpacity: 0.5
                    }
                }
            }).addTo(map);

            // create a popup text from all attributes
            var popupText = '';
            for (var key in pickedJson.properties) {
                popupText = popupText.concat('<b>', key, ':</b> ', pickedJson.properties[key], '<br>');
            }

            // for points append the popup on the pushpin, else create
            // a new poup on the click-coordinate
            if (pickedJson.geometry.type == 'Point') {
                pickedFeature.bindPopup(popupText).openPopup();
            }
            else {
                var popup = L.popup();
                popup.setLatLng(latlng)
                    .setContent(popupText)
                    .openOn(map);
            }
        };

        // returns a layer group for xmap back- and foreground layers
        function getXMap1Layers(url, style, attribution) {
            var background = L.tileLayer('https://api{s}-test.cloud.ptvgroup.com/WMS/GetTile/' +
                (style ? 'xmap-' + style + '-bg' : 'xmap-ajaxbg') + '/{x}/{y}/{z}.png', {
                    minZoom: 0, maxZoom: 19, opacity: 1.0,
                    attribution: attribution,
                    subdomains: '1234'
                });

            var foreground = new L.NonTiledLayer.WMS(url + '?xtok=' + token, {
                zIndex: 0,
                opacity: 1.0,
                layers: style ? 'xmap-' + style + '-fg' : 'xmap-ajaxfg',
                format: 'image/png',
                transparent: true,
                attribution: attribution
            });

            return L.layerGroup([background, foreground]);
        }
    </script>
</body>
</html>