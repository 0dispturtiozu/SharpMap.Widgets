<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">

<html>
<head>
    <title>Leaflet SharpMap Example</title>
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v1.0.0-rc.1/leaflet.css" />
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html,
        body,
        #map {
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="map" />
    <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet/v1.0.0-rc.1/leaflet.js"></script>
    <script src="./NonTiledLayer.js"></script>
    <script src="./NonTiledLayer.WMS.js"></script>
    <script src="./token.js"></script>
    <script>
        // initialize leaflet
        var map = new L.Map('map',
        {
            worldCopyJump: true,
            zoomSnap: 0.125
        });

        // center Karlsruhe
        map.setView(new L.LatLng(50, 10), 6);

        // using the xmap WMS servlet
        var xMapUrl = 'https://api-eu-test.cloud.ptvgroup.com';
        var xMapAttribution = '<a href="http://www.ptvgroup.com">PTV<\/a>, HERE';

        // add the xServer layers
        // set the layer groups for default and sandbox
        var baseLayers = {
            "PTV classic": getLayers(xMapUrl + '/WMS/WMS', "", xMapAttribution),
            "PTV sandbox": getLayers(xMapUrl + '/WMS/WMS', "sandbox", xMapAttribution).addTo(map),
            "PTV silkysand": getLayers(xMapUrl + '/WMS/WMS', "silkysand", xMapAttribution)
        };

        // add dymamic tile layer
        var myTileLayerUrl = 'SharpMapTilesHandler.ashx?x={x}&y={y}&z={z}',
	    myTileLayer = new L.TileLayer(myTileLayerUrl, {
	        maxZoom: 20, minZoom: 0, zIndex: 100
	    });
        map.addLayer(myTileLayer);

        // add dymamic tile layer
        var myOverlayLayer = new L.NonTiledLayer.WMS('SharpMapOverlayHandler.ashx', {
            zIndex: 1,
            opacity: 1.0,
            layers: '',
            format: 'image/png',
            transparent: true
        });
        map.addLayer(myOverlayLayer);

        L.control.layers(baseLayers, {"countries": myTileLayer, "POIs": myOverlayLayer}, { autoZIndex: false }).addTo(map);


        // returns a layer group for xmap back- and foreground layers
        function getLayers(url, style, attribution) {
            var background = new L.TileLayer.WMS(url, {
                maxZoom: 19,
                minZoom: 0,
                opacity: 1.0,
                noWrap: true,
                layers: style? 'xmap-' + style + '-bg' : 'xmap-ajaxbg',
                format: 'image/png',
                transparent: false,
                attribution: attribution
            });

            var foreground = new L.NonTiledLayer.WMS(url + '?xtok=' + token, {
                zIndex: 0,
                opacity: 1.0,
                layers: style? 'xmap-' + style + '-fg' : 'xmap-ajaxfg',
                format: 'image/png',
                transparent: true,
                attribution: attribution,
            });

            return L.layerGroup([background, foreground]);
        }

        // add click handler
        map.on('click', function onMapClick(e) {
            $.ajax({
                url: "SharpMapPickHandler.ashx?lat=" + e.latlng.lat + "&lng=" + e.latlng.lng + "&z=" + map.getZoom(),
                type: "GET",
                success: function (data, status, xhr) {
                    displayResult(data, e.latlng);
                }
            });
        });

        var pickedFeature;
        var popup = L.popup();

        function displayResult(pickedPolygon, latlng) {
            if (pickedFeature)
                map.removeLayer(pickedFeature);

            //var feature = {
            //    "type": "Feature",
            //    "properties": {
            //        "style": {
            //            weight: 4, color: "#222", opacity: 1,
            //            fillColor: "#fff", fillOpacity: 0.5
            //        }
            //    }
            //};

            //feature.geometry = pickedPolygon.geometry;

            pickedFeature = L.geoJson([pickedPolygon], {
                style: function (feature) {  
                    var x = {
                        weight: 4, color: "#222", opacity: 1,
                        fillColor: "#fff", fillOpacity: 0.5
                    }
                    return x;
                }
            }).addTo(map);

            var popupText = '';
            for(var key in pickedPolygon.properties) {
                popupText = popupText.concat('<b>', key, ':</b> ', pickedPolygon.properties[key], '<br>');
            }

            if (pickedPolygon.geometry.type == 'Point') {
                pickedFeature.bindPopup(popupText).openPopup();
            }
            else {
                popup.setLatLng(latlng)
                    .setContent(popupText)
                    .openOn(map);
            }
        };

    </script>
</body>
</html>